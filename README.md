# astrak-api

### Мы используем REST архитектуру в API.

Актуальный адрес тестового API: http://afternoon-dusk-97603.herokuapp.com/

## Работа с Callback для получения событий

Для начала необходимо зарегистрировать наш сервер. Делаем POST запрос на **/events/callback/start** с полями в body:

| Поле     | Тип    | Описание                                |
|----------|--------|-----------------------------------------|
| token    | String | Токен пользователя                      |
| callback | String | URL, на который будут приходить события |

Используем URL в формате https://ip:port/ для вашего же удобства. Вам, конечно, никто не запрещает просто написать туда произвольный текст. Но вы сами прекрасно понимаете, что это совсем не имеет смысла.

Если все успешно, то мы получаем JSON с полем *code: 10*. 

Поднимаем веб-сервер.

На ваш ранее указанный URL будут приходить события в POST формате. Вот пример одного из событий: 
```json
{
  "type": "new_message",
  "event": {
    "message_id": 12,
    "to_id": 1,
    "from_id": 2,
    "created_at": 1581110027,
    "text": "this is a new message!"
  }
}
```

При смене URL Callback сервера приходит событие *'callback_deprecated'*, в котором указаны старый и новый серверы.

Думаю, все понятно. Можно поэкспериментировать.

## Работа с Long Polling для получения событий

Тут всё еще проще. Делаем запрос на **/events/polling** с полями в body: 

| Поле  | Тип    | Описание           |
|-------|--------|--------------------|
| token | String | Токен пользователя |

Ждем ответ сервера. Как только произойдет какое-либо событие, сервер сразу вернет вам ответ. Пример такого события есть выше. События приходят одинаковыми как для Callback, так и для Long Polling.

Почитайте об этих технологиях отдельно.

## Коды ошибок

Небольшая табличка поможет вам при разработке.

| Код | Описание                                  |
|-----|-------------------------------------------|
| -1  | Invalid token                             |
| -2  | Message not sent                          |
| -3  | Parameters are invalid                    |
| -4  | Name cannot be more than 15 characters    |
| -5  | Password cannot be less than 8 characters |
| -6  | User does not exist                       |

## Работа с /users

### POST /users/register

Запрос выполняет регистрацию пользователя и возращает актуальный токен.

* Пароль не может быть короче 8 символов.

* Имя пользователя не может быть длиннее 15 символов.

Body запроса:
| Поле     | Тип    | Описание            |
|----------|--------|---------------------|
| password | String | Пароль пользователя |
| username | String | Имя пользователя    |

### POST /users/login

Запрос возращает токен пользователя по логину и паролю.

Body запроса:
| Поле     | Тип    | Описание            |
|----------|--------|---------------------|
| password | String | Пароль пользователя |
| username | String | Имя пользователя    |

### GET /users/check

Запрос проверяет токен на валидность.

Body запроса:
| Поле  | Тип    | Описание           |
|-------|--------|--------------------|
| token | String | Токен пользователя |

## Работа с /messages

### POST messages/send

Отправляет сообщение пользователю.

Body запроса:
| Поле  | Тип    | Описание           |
|-------|--------|--------------------|
| token | String | Токен пользователя |
| text  | String | Текст сообщения    |
| to    | Number | ID получателя      |

### GET /messages/dialogs

Возращает массив со всеми диалогами пользователя.

Body запроса: 
| Поле  | Тип    | Описание           |
|-------|--------|--------------------|
| token | String | Токен пользователя |

### GET /messages/dialog

Возращает массив сообщений с конкретным пользователем.

Body запроса:
| Поле  | Тип    | Описание                             |
|-------|--------|--------------------------------------|
| token | String | Токен пользователя                   |
| id    | Number | ID пользователя с кем ведется диалог |


